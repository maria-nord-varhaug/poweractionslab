name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: 
  push:
    branches:
      - main
  workflow_dispatch:

  
jobs:
  Deploy-Dev:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install nuget
      shell: PowerShell
      run: |
        $dir = Get-Location
        Invoke-WebRequest "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -OutFile "$dir\nuget.exe" -TimeoutSec 10  -Verbose

    - name: Install powerplatform package deployment tool and unzip annatas newest package to right folder
      shell: PowerShell
      run: |
        & .\preparePackageDeploymentAndUnzipPackage.ps1 -environment weu-dev-develop 
    # - name: Install package deployment module
    #   run: 
    # - name: See packages that can be deployed
    #   run: .\deployPackage.ps1 -environment weu-dev-develop 
    - name: Install CRM Connector
      shell: PowerShell
      run: Install-Module -Name Microsoft.Xrm.Tooling.CrmConnector.PowerShell -RequiredVersion 3.3.0.964 -Force
    - name: Connect to power platform
      shell: PowerShell
      run: |
        & .\deployPackage.ps1 -username "${{vars.DATAVERSE_USERNAME }}" -password (ConvertTo-SecureString "${{secrets.DATAVERSE_PASSWORD}}" -ASPlainText -Force)
    - name: Remove nuget
      shell: PowerShell
      run: |
        $dir = Get-Location
        Remove-Item "$dir\nuget.exe"


