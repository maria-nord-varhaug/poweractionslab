name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: 
  workflow_dispatch:
    inputs:
      version: 
        description: 'The dealer UI version to deploy, in format X.X.X, e.g. 0.1.2'
        required: true
      environment: 
        description: 'The environment to deploy to, e.g. weu-dev-develop'
        required: true

  
jobs:
  Deploy-Dev:
    defaults:
      run:
        shell: PowerShell # VERY important, this code does not work in powershell core
    runs-on: windows-latest
    steps:
    - name: Check input # kinda unnecessary but whatever
      run: |
        if( ${{github.event.inputs.environment}} != weu-dev-develop){
          exit 1
        }

    - uses: actions/checkout@v4
    - name: Install nuget
      run: |
        Invoke-WebRequest "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -OutFile "(Get-Location)\nuget.exe" -TimeoutSec 10  -Verbose

    - name: Install powerplatform package deployment tool and unzip annatas newest package to right folder
      run: |
        & .\preparePackageDeploymentAndUnzipPackage.ps1 -environment weu-dev-develop -version ${{ github.event.inputs.version }}

    - name: Install CRM Connector
      run: Install-Module -Name Microsoft.Xrm.Tooling.CrmConnector.PowerShell -RequiredVersion 3.3.0.964 -Force

      # redirect isn't really an important value, this is a placehodler:
    - name: Connect to power platform
      run: |
        $ .\deployPackage.ps1 -url ${{vars.SERVER_URL}} -clientId ${{secrets.DV_CLIENT_ID}} -clientSecret ${{secrets.DV_CLIENT_SECRET}} -redirect "app://58145B91-0C36-4500-8554-080854F2AC97" -environment weu-dev-develop -version ${{ github.event.inputs.version }}

    - name: Remove nuget
      run: |
        Remove-Item "$(Get-Location)\nuget.exe"
